---
title: 'HW 2: Анализ маркетинговой компании'
author: "Шаповал Александр, avshapoval"
output: 
  html_document:
    code_folding: hide
---

## Задача

Необходимо проанализировать предоставленные данные, найти закономерности и предоставить отчет касательно связи откликов клиентов и информации о них. Рассмотреть данные людей, откликнувшихся на акцию, и определить, от чего зависит частота посещения ими магазина. Это важно, так как такие клиенты считаются лояльными к магазину и должны быть удовлетворены в первую очередь. Кроме того, для проверки целесообразности дальнейшего расширения маркетинговой акции необходимо построить достаточно точную модель, способную по данным о клиенте определить, откликнется ли он на маркетинговую акцию или нет. Точной считается модель, которая способна определить отклик по крайней мере 3 из 4 человек.

### Загрузка данных и преобразование

```{r setup}
knitr::opts_chunk$set(warning=FALSE, message=FALSE, include=TRUE, results = 'hide')
```

```{r 1}
marketing = read.csv("~/shared/minor2_2021/1-Intro/hw2/marketing_campaign.csv")

library(dplyr)
library(rpart)
library(rpart.plot)
library(coin)
library(lubridate)
```

Уберем данные с na из датасета, измееним тип Response на factor, Dt_Customer на Date, добавим столбец month_since_first_reg - количество месяцев, равное дате регистрации клиента - дата первой регистрации клиента. Также изменим тип Marital_Status на factor.

```{r}
marketing = marketing %>% na.omit()

marketing$Response = as.factor(marketing$Response)

marketing$Dt_Customer = as.Date(marketing$Dt_Customer, format = "%d-%m-%Y")
first_registration = min(year(marketing$Dt_Customer)*12 + month(marketing$Dt_Customer))
marketing$month_since_first_reg = year(marketing$Dt_Customer)*12 + month(marketing$Dt_Customer) - first_registration

marketing$Marital_Status = as.factor(marketing$Marital_Status)
```
### Исследовательские вопросы и тесты



#### _1) Есть ли зависимость между датой регистрации человека и датой последнего посещения магазина, и если да, как они взаимосвязаны?_

```{r}
marketing2 = marketing %>% filter(Response==1)
independence_test(marketing2$month_since_first_reg ~ marketing2$Recency)
```
##### **Нулевая гипотеза**

Нулевой гипотезой будет считаться утверждение, что разницы в дате последнего посещения магазина у людей с разной датой регистрации нет.

##### **Преобразование данных и проверка гипотезы**

Отфильтруем датасет, оставив только клиентов, откликнувшихся на рекламную кампанию, после чего проведем тест перестановок с целью выявить, следует ли отвергнуть нулевую гипотезу. Получим, что p-value равно 1,462 * 10^(-6), а значит, статистически значимая разница есть и мы отвергаем нулевую гипотезу.

Таким образом, получив, что статистически значимая разница существует, проверим корреляцию между датой последнего посещения магазина и датой регистрации.

```{r}
rec_msfr_cor = cor.test(marketing2$month_since_first_reg, marketing2$Recency)
rec_msfr_cor$p.value
```
Получим, что p-value равно 9.943063*10^(-7), то есть корреляция статиcтически значима и коэффициент корреляции равен `r rec_msfr_cor$estimate`. Перед нами слабая корреляция с отрицательным коэффициентом между двумя переменными. 

##### **Вывод**

Среди откликнувшихся существует следующая тенденция: чем позже клиент стал клиентом компании, тем меньше число дней, прошедших с момента последней покупки. 


#### _2) Есть ли зависимость между готовностью человека откликнуться на кампанию и его доходом?_

##### **Нулевая гипотеза**

Разницы в среднем доходе людей в зависимости от готовности откликнуться на компанию нет.

##### **Преобразование данных и проверка гипотезы**

Проведем тест перестановок для переменных "Response" и "Income" с целью выявить, следует ли отвергнуть нулевую гипотезу. 

```{r}
independence_test(marketing$Response ~ marketing$Income)
```
Получим, что p-value равно 5.278* 10^(-8), а значит, статистически значимая разница есть и мы отвергаем нулевую гипотезу. Теперь рассмотрим, у кого средний доход выше - у людей, откликнувшихся на маркетинговую акцию или наоборот.

```{r}
# Делаем красивый вывод таблиц, для чего необходимо подключить lemon
library(lemon)
knit_print.data.frame <- lemon_print
```


```{r render=lemon_print, results='markup'}
marketing %>% group_by(Response) %>% summarise("Mean income" = mean(Income))
```

Получим, что доход людей, откликнувшихся на акцию в среднем выше практически на 10 тысяч. 

##### **Вывод**

Для увеличения количества откликов на акцию необходимо сфокусироваться на людях с более высоким доходом.


#### _3) Есть ли зависимость между готовностью человека откликнуться на кампанию и числом дней, прошедших с последней покупки?_

##### **Нулевая гипотеза**

Разницы в числе дней, прошедших с последней покупки между откликнувшимися и проигнорировавшими компанию нет.

##### **Преобразование данных и проверка гипотезы**

Проведем тест перестановок для переменных "Response" и "Recency" с целью выявить, следует ли отвергнуть нулевую гипотезу. 

```{r}
independence_test(marketing$Response ~ marketing$Recency)
```
Получим, что p-value меньше 2.2*10^(-16), а значит, статистически значимая разница есть и мы отвергаем нулевую гипотезу. Теперь рассмотрим, у кого среднее количество дней после последней покупки выше  - у людей, откликнувшихся на маркетинговую акцию или наоборот.


```{r render=lemon_print, include = T, results='markup'}
marketing %>% group_by(Response) %>% summarise("Mean recency" = mean(Recency))
```

Получим, что количество дней после последней покупки у людей, откликнувшихся на акцию в среднем ниже на 17

##### **Вывод**

Чем меньше прошло дней с последней покупки, тем больше вероятность, что клиент откликнется на акцию.


#### _4) Есть ли зависимость между готовностью человека откликнуться на кампанию и тем, подавал ли он жалобы за последние 2 года?_

##### **Нулевая гипотеза**

Подача жалобы не имеет значения для откликнувшихся и проигнорировавших компанию.

##### **Преобразование данных и проверка гипотезы**

Проведем тест Хи-квадрат для переменных Response и Complain с целью выявить, следует ли отвергнуть нулевую гипотезу. 

```{r}
chisq.test(marketing$Response, marketing$Complain)
```
Получим, что p-value равно 1, а значит, статистически значимой разницы нет и мы принимаем нулевую гипотезу.

##### **Вывод**

Подача жалобы не влияет на принятие решение клиентом об отклике.

#### _5) Есть ли зависимость между готовностью человека откликнуться на кампанию и откликом на предыдущую?_

##### **Нулевая гипотеза**

Отклик на предыдущую кампанию не имеет значения для откликнувшихся и проигнорировавших текущую кампанию.

##### **Преобразование данных и проверка гипотезы**

Проведем тест Хи-квадрат для переменных "Response" и "AcceptedCmp" с целью выявить, следует ли отвергнуть нулевую гипотезу. 

```{r}
chisq.test(marketing$Response, marketing$AcceptedCmp)
```
Получим, что p-value менее 2.2*10^(-16), а значит, статистически значимая разница есть и мы отвергаем нулевую гипотезу. Теперь проверим, как отклик на предыдущую акцию влияет на отклик на текущую.

```{r}
resp_acc = table(marketing$Response, marketing$AcceptedCmp)
accuracy = (resp_acc[1,1] + resp_acc[2,2])/sum(resp_acc) * 100

```

Получим, что в `r resp_acc[1,1] + resp_acc[2,2]` случаев из `r sum(resp_acc)`, то есть в `r round(accuracy, digits=2)` процентах случаев предыдущий отклик влияет на текущий

##### **Вывод**

`r round(accuracy, digits=2)` процентов клиентов приняли такое же решение об отклике, как и на предыдущую акцию, что означает, что учитывание предыдущего отклика на акцию достаточно важно для планирования следующей.


### Предсказание отклика на кампанию

Теперь построим модель на основе машинного обучения, способную предсказывать отклик на акцию и соответствующую условиям задачи заказчика - не менее 3 из 4 людей должны быть предсказаны правильно. Для этого разобьем датасет marketing на обучающую и тестовую выборки - 80 и 20 процентов соответственно. После этого построим дерево решений на обучающей выборке по параметрам Income, Recency и AcceptedCmp, после чего на его основе предскажем результат для тестовой выборки.
```{r}
set.seed(4)
train = sample_frac(marketing, 0.8)

tree <- rpart(Response ~ Income + Recency + AcceptedCmp, method = "class", data =train)
rpart.plot(tree)


pred = predict(tree, type="class", data = train)

anti_train = anti_join(marketing, train)

pred2 = predict(tree, type="class", newdata = anti_train)
t = table(pred2, anti_train$Response)

(t[1,1] + t[2,2])/sum(t)

```
Точность предсказаний для тестовой выборки оказалась равна `r round((t[1,1] + t[2,2])/sum(t)*100, digits = 2)`, что соответствует условиям заказчика.

Теперь рассмотрим точность предсказаний для различных демографических групп клиентов. Рассмотрим 3 группы - молодые люди, родившиеся до 1970 года, взрослые, родившиеся с 1940 по 1970 и пожилые, родившиеся до 1940.


```{r}
young = marketing %>% filter(Year_Birth>= 1970 & Year_Birth < 2000)
adult = marketing %>% filter(Year_Birth>= 1940 & Year_Birth < 1970)
old = marketing %>% filter(Year_Birth < 1940)

pred.young = predict(tree, type="class", newdata = young)
pred.adult = predict(tree, type="class", newdata = adult)
pred.old = predict(tree, type="class", newdata = old)

t.young = table(pred.young, young$Response)
y =(t.young[1,1] + t.young[2,2])/sum(t.young)

t.adult = table(pred.adult, adult$Response)
a = (t.adult[1,1] + t.adult[2,2])/sum(t.adult)

t.old = table(pred.old, old$Response)
o = (t.old[1,1] + t.old[2,2])/sum(t.old)


df = data.frame(
  age = c("молодые(1970 - 2000)", "взрослые(1940 - 1970)", "пожилые(1893 - 1940)"),
  accuracy_percentage = c(y, a, o)
  
)

library(ggplot2)
age_groups_bar = ggplot()+
  geom_bar(mapping = aes(age, accuracy_percentage*100), stat = "identity", data = df, fill = "chartreuse4") + 
  xlab("Возрастные группы") +
  ylab("Точность предсказаний моделью")+
  ggtitle("Точность предсказания модели для разных возрастных групп")
age_groups_bar
```
\
Применив получившуюся модель к 3 группам, получим что точность составляет:
Молодые: 79.9%
Взрослые: 80.6%
Пожилые: 66.7%

Таким образом, для повышенной точности предсказания рекомендуется запускать маркетинговую компанию в районах с преимущественно молодым и среднего возраста населением.


## Общие выводы

Проделанная работа будет ценной для менеджмента сети магазинов, запустившего пробную акцию. В работе были исследованы зависимости и корреляции в данных клиентов, оставивших информацию о себе в течение маркетингого опроса. В результате, менеджменту сети магазинов предложены зависимости между показателями клиентов и корреляции между ними.

